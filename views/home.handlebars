{{> top_nav}}
{{> modal}}

<script>
    // handle navigation from logout
    const urlParams = new URLSearchParams(window.location.search)
    const shouldRemoveToken = urlParams.get('logout')
    var authTokenKey = "{{authTokenKey}}"
    if (shouldRemoveToken) {
        localStorage.removeItem(authTokenKey)
        window.history.replaceState({}, document.title, '/')
    }

    // check for valid token
    var token = localStorage.getItem(authTokenKey)
    if (!!token) {
        axios({
            method: 'post',
                url: "{{loginWithTokenRoute}}",
                headers: {
                    [authTokenKey]: token
                }
        }).then(res => {
            if (!!res.data[authTokenKey]) {
                var authNavItem = document.getElementById('auth-top-nav-item')
                var dashboardLinkNavItem = document.getElementById('dashboard-link-top-nav-item')
                authNavItem.hidden = true
                dashboardLinkNavItem.hidden = false
                var appLink = document.getElementById('app-link')
                appLink.setAttribute('href', "{{appUrl}}" + '?'  + authTokenKey + '=' + token)
            }
        })
        
    }

    // open and close login and registration modals
    function openAuthModal (authAction) {
        const authModal = document.getElementById('auth-modal')
        const registrationForm = document.getElementById('registrationForm')
        const loginForm = document.getElementById('loginForm')

        if (authAction === 'register') {
            registrationForm.hidden = false
            loginForm.hidden = true
        }
        if (authAction === 'login') {
            registrationForm.hidden = true
            loginForm.hidden = false
        }
        authModal.hidden = false
    }

    function closeAuthModal () {
        const authModal = document.getElementById('auth-modal')
        authModal.hidden = true
    }

    const authModal = document.getElementById('auth-modal')
    authModal.addEventListener('click', function(event) {
        if (event.target.id === 'auth-modal-background') closeAuthModal()
    })

</script>


<script>
  window.fbAsyncInit = function() {
    FB.init({
      appId      : '1397238603644248',
      cookie     : true,
      xfbml      : true,
      version    : 'v6.0'
    });
  }
</script>
<script async defer src="https://connect.facebook.net/en_US/sdk.js"></script>
<script>

    function statusChangeCallback(response) {  // Called with the results from FB.getLoginStatus().
    console.log('statusChangeCallback');
    console.log(response);                   // The current login status of the person.
    if (response.status === 'connected') {   // Logged into your webpage and Facebook.
      testAPI();  
    } else {                                 // Not logged into your webpage or we are unable to tell.
    console.log('NOT AUTHENTICATED')
      FB.login(function(response) {

        if (response.authResponse) {
            console.log('Welcome!  Fetching your information.... ');
            console.log('login response', response); // dump complete info
            testAPI(); 
            
        } else {
            //user hit cancel button
            console.log('User cancelled login or did not fully authorize.');

        }
    }, {
        scope: 'public_profile,email'
    });
    }
  }

  function checkLoginState() {               // Called when a person is finished with the Login Button.
    FB.getLoginStatus(function(response) {   // See the onlogin handler
      statusChangeCallback(response);
    });
  }

  function testAPI() {                      // Testing Graph API after login.  See statusChangeCallback() for when this call is made.
    console.log('Welcome!  Fetching your information.... ');
    FB.api('/me', {fields: 'id, first_name, last_name, email, picture.type(large)'}, function(response) {
        console.log('login response:', response)
      console.log('Successful login for: ' + response.name);
      document.getElementById('status').innerHTML =
        'Thanks for logging in, ' + response.first_name + '!';
    });
  }

</script>

<button onclick="checkLoginState();">Login to Facebook</button>

<div id="status">
</div>